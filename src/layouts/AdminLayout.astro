---
import "../styles/global.css";
import data from "../data/data.json";

interface Props {
  title?: string;
  activeNav?: string;
}

const { title = "Admin", activeNav = "" } = Astro.props;

const navItems = [
  { id: "dashboard", label: "Dashboard", icon: "üìä", href: "/admin/dashboard" },
  { id: "ordini", label: "Ordini Live", icon: "üîî", href: "/admin/ordini" },
  { id: "prodotti", label: "Prodotti", icon: "üç∏", href: "/admin/prodotti" },
  { id: "categorie", label: "Categorie", icon: "üìÇ", href: "/admin/categorie" },
  { id: "tavoli", label: "Tavoli & QR", icon: "ü™ë", href: "/admin/tavoli" },
  { id: "impostazioni", label: "Impostazioni", icon: "‚öôÔ∏è", href: "/admin/impostazioni" },
];
---

<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{title} ‚Äî Admin | {data.pub.nome}</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" href="/favicon.ico" />
  <style>
    body { margin: 0; display: none; /* Nascondiamo il body finch√© Firebase non conferma chi sei */ }
    body.auth-checked { display: block; }
    .admin-wrap { display: flex; min-height: 100vh; }
    .sidebar { width: 240px; flex-shrink: 0; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; position: sticky; top: 0; height: 100vh; overflow-y: auto; }
    .sidebar-logo { padding: 24px 20px; border-bottom: 1px solid var(--border); }
    .sidebar-logo .pub-name { font-family: var(--font-display); font-size: 1.1rem; color: var(--accent-light); font-weight: 700; }
    .sidebar-logo .admin-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-top: 2px; }
    .sidebar-nav { flex: 1; padding: 16px 12px; display: flex; flex-direction: column; gap: 4px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-radius: var(--radius-sm); color: var(--text-soft); font-size: 0.9rem; font-weight: 500; transition: all var(--transition); }
    .nav-item:hover { background: rgba(200,146,42,0.08); color: var(--text); }
    .nav-item.active { background: rgba(200,146,42,0.15); color: var(--accent-light); font-weight: 600; }
    .nav-icon { font-size: 1.1rem; width: 22px; text-align: center; }
    .sidebar-footer { padding: 16px 12px; border-top: 1px solid var(--border); }
    .logout-btn { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: var(--radius-sm); color: var(--muted); font-size: 0.85rem; transition: all var(--transition); cursor: pointer; background: none; border: none; font-family: var(--font-body); width: 100%; }
    .logout-btn:hover { color: var(--danger); }
    .main-content { flex: 1; padding: 32px; overflow-y: auto; }
    .page-header { margin-bottom: 32px; }
    .page-header h1 { font-size: 1.8rem; margin-bottom: 4px; }
    .page-header p { font-size: 0.9rem; color: var(--muted); }
  </style>
</head>
<body>
  <div class="admin-wrap">
    <aside class="sidebar">
      <div class="sidebar-logo">
        <div class="pub-name">{data.pub.nome}</div>
        <div class="admin-label">Pannello Admin</div>
      </div>
      <nav class="sidebar-nav">
        {navItems.map(item => (
          <a href={item.href} class={`nav-item ${activeNav === item.id ? 'active' : ''}`}>
            <span class="nav-icon">{item.icon}</span>
            {item.label}
          </a>
        ))}
      </nav>
      <div class="sidebar-footer">
        <button class="logout-btn" id="logoutBtn">
          <span>üö™</span> Esci dal Pannello
        </button>
      </div>
    </aside>

    <main class="main-content">
      <slot />
    </main>
  </div>

  <script>
    import { getFirebaseClient } from "../lib/firebase-client";
    import { onAuthStateChanged, signOut } from "firebase/auth";

    const { auth } = getFirebaseClient();

    // Ascolta lo stato di login in tempo reale
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // L'utente √® loggato con Firebase! Mostra la pagina
        document.body.classList.add("auth-checked");
      } else {
        // Sconosciuto! Sbattilo fuori
        window.location.replace("/admin");
      }
    });

    document.getElementById("logoutBtn")?.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "/admin";
    });
  </script>
</body>
</html>