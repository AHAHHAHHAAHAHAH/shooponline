---
import Layout from "../layouts/Layout.astro";
import data from "../data/data.json";
---

<Layout title={`Menu â€” ${data.pub.nome}`} description={`Menu digitale di ${data.pub.nome}`}>
  <div class="menu-sticky-header">
    <div class="container">
      <h1 class="menu-page-title">Il nostro Menu</h1>
      <div class="categoria-scroll-nav" id="categoriaNav">
        </div>
    </div>
  </div>

  <div class="container" style="padding-top: 24px; padding-bottom: 100px;">
    <main class="menu-content" id="menuContent">
      <div style="text-align:center; padding: 40px; color: var(--accent);">
        <span class="spinner"></span>
        <p>Caricamento menu...</p>
      </div>
    </main>
  </div>

  <a href="/checkout" class="floating-cart" id="floatingCart" style="display:none;">
    <span>ðŸ›’ Vedi Carrello</span>
    <div class="cart-badge" id="cartCount">0</div>
  </a>
</Layout>

<style>
  .menu-sticky-header {
    position: sticky;
    top: 0;
    background: rgba(7, 7, 9, 0.95);
    backdrop-filter: blur(10px);
    z-index: 100;
    border-bottom: 1px solid var(--border);
    padding: 16px 0;
  }
  .menu-page-title {
    font-family: var(--font-display);
    font-size: 1.8rem;
    margin-bottom: 12px;
  }
  .categoria-scroll-nav {
    display: flex;
    overflow-x: auto;
    gap: 12px;
    padding-bottom: 8px;
    scrollbar-width: none; /* Nasconde scrollbar su Firefox */
  }
  .categoria-scroll-nav::-webkit-scrollbar { display: none; } /* Nasconde scrollbar su Chrome */
  
  :global(.cat-pill) {
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--border);
    padding: 8px 16px;
    border-radius: 99px;
    white-space: nowrap;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--text-soft);
    transition: all 0.2s ease;
  }
  :global(.cat-pill.active) {
    background: var(--accent);
    color: #000;
    border-color: var(--accent);
  }
  .categoria-section { margin-bottom: 48px; scroll-margin-top: 140px; }
  .categoria-title { font-family: var(--font-display); font-size: 1.6rem; color: var(--accent-light); margin-bottom: 16px; border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 8px; }
</style>

<script>
  import { getFirebaseClient } from "../lib/firebase-client";
  import { collection, onSnapshot, query, orderBy } from "firebase/firestore";

  const contentEl = document.getElementById("menuContent");
  const navEl = document.getElementById("categoriaNav");

  if (contentEl && navEl) {
    const { db } = getFirebaseClient();
    let categorie: any[] = [];
    let prodotti: any[] = [];
    let catLoaded = false;
    let prodLoaded = false;

    onSnapshot(query(collection(db, "categorie"), orderBy("ordinamento", "asc")), (snap) => {
      categorie = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      catLoaded = true;
      if (prodLoaded) renderMenu();
    });

    onSnapshot(collection(db, "prodotti"), (snap) => {
      prodotti = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      prodLoaded = true;
      if (catLoaded) renderMenu();
    });

    function renderMenu() {
      const prodottiAttivi = prodotti.filter((p: any) => p.disponibile !== false);

      if (categorie.length === 0 || prodottiAttivi.length === 0) {
        contentEl!.innerHTML = `<div style="text-align:center; color: var(--muted);">Menu in aggiornamento.</div>`;
        return;
      }

      let htmlContent = "";
      let htmlNav = "";

      categorie.forEach((cat: any, index: number) => {
        const prodottiCat = prodottiAttivi.filter((p: any) => p.categoriaId === cat.id);
        if (prodottiCat.length === 0) return;

        htmlNav += `<a href="#cat-${cat.id}" class="cat-pill ${index === 0 ? 'active' : ''}">${cat.emoji || ''} ${cat.nome}</a>`;

        htmlContent += `
          <div class="categoria-section" id="cat-${cat.id}">
            <h2 class="categoria-title">${cat.nome}</h2>
            <div class="menu-compact-grid">
              ${prodottiCat.map((p: any) => `
                <div class="prodotto-row">
                  <div class="prodotto-thumb-wrap">
                    <img src="${p.immagine || '/images/placeholder.svg'}" onerror="this.src='/images/placeholder.svg'" />
                  </div>
                  <div class="prodotto-row-info">
                    <div class="prodotto-row-header">
                      <div class="prodotto-row-title">${p.nome}</div>
                    </div>
                    <div class="prodotto-row-desc">${p.descrizione || ''}</div>
                    <div class="prodotto-row-footer">
                      <div class="prodotto-row-price">â‚¬ ${Number(p.prezzo).toFixed(2).replace('.', ',')}</div>
                      <button class="add-btn" onclick='aggiungiAlCarrello(${JSON.stringify(p).replace(/'/g, "&#39;")})'>+</button>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });

      navEl!.innerHTML = htmlNav;
      contentEl!.innerHTML = htmlContent;
      aggiornaBadgeCarrello();
    }
  }

  const CART_KEY = "puborder_cart";
  (window as any).aggiungiAlCarrello = function(prodotto: any) {
    let cart = JSON.parse(localStorage.getItem(CART_KEY) || "[]");
    const idx = cart.findIndex((i: any) => i.id === prodotto.id);
    if (idx >= 0) cart[idx].quantita += 1;
    else cart.push({ id: prodotto.id, nome: prodotto.nome, prezzo: Number(prodotto.prezzo), immagine: prodotto.immagine || '/images/placeholder.svg', quantita: 1 });
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
    
    // Feedback visivo immediato e aggiornamento badge
    aggiornaBadgeCarrello();
    const btn = event?.currentTarget as HTMLButtonElement;
    if(btn) {
        const oldText = btn.innerHTML;
        btn.innerHTML = "âœ“";
        btn.style.background = "var(--success)";
        btn.style.color = "#fff";
        btn.style.borderColor = "var(--success)";
        setTimeout(() => { btn.innerHTML = oldText; btn.style.cssText = ""; }, 1000);
    }
  };

  function aggiornaBadgeCarrello() {
    const cart = JSON.parse(localStorage.getItem(CART_KEY) || "[]");
    const count = cart.reduce((acc: number, item: any) => acc + item.quantita, 0);
    const cartBtn = document.getElementById("floatingCart");
    const badge = document.getElementById("cartCount");
    if (cartBtn && badge) {
      if (count > 0) {
        cartBtn.style.display = "flex";
        badge.textContent = count.toString();
      } else {
        cartBtn.style.display = "none";
      }
    }
  }

  // InterattivitÃ  pills navigazione
  document.addEventListener("scroll", () => {
      const sections = document.querySelectorAll(".categoria-section");
      const pills = document.querySelectorAll(".cat-pill");
      let currentId = "";
      sections.forEach((sec: any) => {
          if (window.scrollY >= (sec.offsetTop - 150)) currentId = sec.getAttribute("id");
      });
      pills.forEach(pill => {
          pill.classList.remove("active");
          if (pill.getAttribute("href") === `#${currentId}`) pill.classList.add("active");
      });
  });
</script>