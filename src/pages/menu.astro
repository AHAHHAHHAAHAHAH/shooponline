---
import Layout from "../layouts/Layout.astro";
import data from "../data/data.json";

const pub = data.pub;
const categorie = data.categorie.filter(c => c.attiva).sort((a,b) => a.ordinamento - b.ordinamento);
const prodotti = data.prodotti.filter(p => p.disponibile);
---

<Layout
  title={`Menu ‚Äî ${pub.nome}`}
  description={`Sfoglia il menu completo di ${pub.nome}. Cocktail, antipasti, birre e molto altro.`}
>
  <div class="menu-page">
    <!-- NAV -->
    <nav class="menu-nav">
      <div class="container" style="display:flex;align-items:center;justify-content:space-between;padding-top:20px;padding-bottom:20px;">
        <a href="/" class="nav-logo-text">{pub.nome}</a>
        <div style="display:flex;gap:12px;">
          <a href="/" class="btn btn-ghost btn-sm">‚Üê Home</a>
        </div>
      </div>
    </nav>

    <!-- HEADER MENU -->
    <div class="menu-header container">
      <span class="kicker">Menu completo</span>
      <h1>Tutto quello che offriamo</h1>
      <p>Clicca su un prodotto per i dettagli. Per ordinare, scansiona il QR al tuo tavolo.</p>
    </div>

    <!-- STICKY CATEGORY TABS -->
    <div class="cat-tabs-wrap">
      <div class="cat-tabs container">
        {categorie.map(cat => (
          <a href={`#cat-${cat.id}`} class="cat-tab">
            <span>{cat.emoji}</span> {cat.nome}
          </a>
        ))}
      </div>
    </div>

    <!-- PRODOTTI PER CATEGORIA -->
    <div class="container menu-content">
      {categorie.map(cat => {
        const items = prodotti.filter(p => p.categoriaId === cat.id);
        if (items.length === 0) return null;
        return (
          <div id={`cat-${cat.id}`} class="cat-section">
            <div class="cat-header">
              <span class="cat-emoji-lg">{cat.emoji}</span>
              <div>
                <h2>{cat.nome}</h2>
                <p>{cat.descrizione}</p>
              </div>
            </div>
            <div class="items-grid">
              {items.map(p => (
                <div class="menu-item card" id={p.id} data-prodotto={JSON.stringify(p)}>
                  <div class="item-img-wrap">
                    <img src={p.immagine} alt={p.nome} loading="lazy" onerror="this.src='/images/placeholder.svg'" />
                    {!p.disponibile && <div class="unavail-overlay">Non disponibile</div>}
                  </div>
                  <div class="item-body">
                    <div class="item-tags">
                      {p.tag.slice(0,2).map(t => <span class="item-tag">{t}</span>)}
                      {p.alcolico && <span class="item-tag alc">{p.gradazione}</span>}
                    </div>
                    <h3 class="item-nome">{p.nome}</h3>
                    <p class="item-desc">{p.descrizione}</p>
                    {p.allergeni.length > 0 && (
                      <div class="item-allergeni">
                        <span class="allerg-label">Allergeni:</span>
                        {p.allergeni.join(", ")}
                      </div>
                    )}
                    <div class="item-footer">
                      <span class="price">{pub.currency}{p.prezzo.toFixed(2).replace('.', ',')}</span>
                      <button
                        class="btn btn-primary btn-sm add-to-cart-btn"
                        data-id={p.id}
                        data-nome={p.nome}
                        data-prezzo={p.prezzo}
                        data-img={p.immagine}
                      >
                        + Aggiungi
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        );
      })}
    </div>

    <!-- CARRELLO FAB -->
    <div class="cart-fab-wrap" id="cartFab" style="display:none;">
      <button class="cart-fab-btn btn btn-primary" onclick="window.location.href='/checkout'">
        <span id="cartCount">0</span>
        <span>üõí Vai al carrello</span>
        <span class="cart-total" id="cartTotal">‚Ç¨ 0,00</span>
      </button>
    </div>
  </div>
</Layout>

<style>
  .menu-page { min-height: 100vh; }
  .menu-nav { background: rgba(10,8,0,0.9); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 50; }
  .nav-logo-text { font-family: var(--font-display); font-size: 1.3rem; color: var(--accent-light); font-weight: 700; }
  .menu-header { padding: 48px 24px 32px; }
  .menu-header h1 { margin: 8px 0 12px; }

  .cat-tabs-wrap { position: sticky; top: 65px; z-index: 40; background: var(--bg); border-bottom: 1px solid var(--border); }
  .cat-tabs { display: flex; gap: 4px; overflow-x: auto; padding: 12px 24px; scrollbar-width: none; }
  .cat-tabs::-webkit-scrollbar { display: none; }
  .cat-tab {
    display: flex; align-items: center; gap: 6px; white-space: nowrap;
    padding: 8px 16px; border-radius: 99px; font-size: 0.85rem; font-weight: 600;
    color: var(--muted); border: 1px solid transparent; transition: all var(--transition);
  }
  .cat-tab:hover { color: var(--accent); border-color: var(--border); }

  .menu-content { padding: 40px 24px 120px; }
  .cat-section { margin-bottom: 64px; }
  .cat-header { display: flex; align-items: center; gap: 20px; margin-bottom: 32px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
  .cat-emoji-lg { font-size: 3rem; }
  .cat-header h2 { margin-bottom: 4px; }

  .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
  .menu-item { overflow: hidden; display: flex; flex-direction: column; }
  .item-img-wrap { position: relative; aspect-ratio: 4/3; overflow: hidden; }
  .item-img-wrap img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s ease; }
  .menu-item:hover .item-img-wrap img { transform: scale(1.03); }
  .unavail-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; }
  .item-body { padding: 16px; flex: 1; display: flex; flex-direction: column; }
  .item-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px; }
  .item-tag { font-size: 0.7rem; padding: 2px 8px; border-radius: 99px; background: rgba(200,146,42,0.1); color: var(--accent); font-weight: 600; }
  .item-tag.alc { background: rgba(192,57,43,0.1); color: var(--danger); }
  .item-nome { font-family: var(--font-display); font-size: 1.15rem; margin-bottom: 8px; }
  .item-desc { font-size: 0.85rem; color: var(--muted); line-height: 1.5; flex: 1; margin-bottom: 12px; }
  .item-allergeni { font-size: 0.75rem; color: var(--muted); padding: 6px 10px; background: rgba(255,255,255,0.03); border-radius: 4px; margin-bottom: 12px; }
  .allerg-label { font-weight: 700; color: #e67e22; }
  .item-footer { display: flex; align-items: center; justify-content: space-between; }

  /* CART FAB */
  .cart-fab-wrap { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); z-index: 100; animation: slideUp 0.3s ease; }
  .cart-fab-btn { display: flex; align-items: center; gap: 12px; padding: 16px 28px; border-radius: 99px; font-size: 1rem; box-shadow: 0 8px 32px rgba(200,146,42,0.4); white-space: nowrap; }
  .cart-total { font-family: var(--font-display); font-size: 1.1rem; font-weight: 700; }

  @media (max-width: 768px) {
    .items-grid { grid-template-columns: 1fr 1fr; gap: 12px; }
    .item-body { padding: 12px; }
    .item-nome { font-size: 1rem; }
  }
  @media (max-width: 480px) {
    .items-grid { grid-template-columns: 1fr; }
  }
</style>

<script>
  // ‚îÄ‚îÄ GESTIONE CARRELLO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const CART_KEY = "puborder_cart";

  interface CartItem {
    id: string;
    nome: string;
    prezzo: number;
    immagine: string;
    quantita: number;
  }

  function getCart(): CartItem[] {
    try { return JSON.parse(localStorage.getItem(CART_KEY) || "[]"); } catch { return []; }
  }

  function saveCart(cart: CartItem[]) {
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
  }

  function updateCartUI() {
    const cart = getCart();
    const total = cart.reduce((s, i) => s + i.prezzo * i.quantita, 0);
    const count = cart.reduce((s, i) => s + i.quantita, 0);
    const fab = document.getElementById("cartFab");
    const countEl = document.getElementById("cartCount");
    const totalEl = document.getElementById("cartTotal");
    if (fab) fab.style.display = count > 0 ? "block" : "none";
    if (countEl) countEl.textContent = String(count);
    if (totalEl) totalEl.textContent = `‚Ç¨ ${total.toFixed(2).replace(".", ",")}`;
  }

  function addToCart(id: string, nome: string, prezzo: number, immagine: string) {
    const cart = getCart();
    const idx = cart.findIndex(i => i.id === id);
    if (idx >= 0) {
      cart[idx].quantita += 1;
    } else {
      cart.push({ id, nome, prezzo, immagine, quantita: 1 });
    }
    saveCart(cart);
    updateCartUI();
    showToast(`${nome} aggiunto al carrello!`);
  }

  function showToast(msg: string) {
    const t = document.createElement("div");
    t.className = "toast toast-success";
    t.textContent = "‚úì " + msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2500);
  }

  document.querySelectorAll(".add-to-cart-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const b = btn as HTMLButtonElement;
      addToCart(b.dataset.id!, b.dataset.nome!, parseFloat(b.dataset.prezzo!), b.dataset.img!);
    });
  });

  updateCartUI();

  // Highlight tab attiva sullo scroll
  const catSections = document.querySelectorAll(".cat-section");
  const catTabs = document.querySelectorAll(".cat-tab");
  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const id = entry.target.id;
        catTabs.forEach(tab => {
          const href = tab.getAttribute("href")?.slice(1);
          tab.classList.toggle("active", href === id);
        });
      }
    });
  }, { rootMargin: "-40% 0px -55% 0px" });
  catSections.forEach(s => observer.observe(s));
</script>
