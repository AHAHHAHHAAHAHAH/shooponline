---
import Layout from "../layouts/Layout.astro";
import data from "../data/data.json";

// Manteniamo solo le categorie dal JSON per disegnare l'interfaccia
const categorie = data.categorie;
const categorieJson = JSON.stringify(categorie);
---

<Layout title={`Menu — ${data.pub.nome}`} description={`Esplora il menu di ${data.pub.nome}`}>
  <section class="menu-hero">
    <div class="container menu-hero-inner">
      <h1 class="reveal-text">Il nostro Menu</h1>
      <p class="reveal-text delay-1">Scopri le nostre selezioni di drink e food.</p>
    </div>
  </section>

  <div class="container menu-layout">
    <aside class="menu-sidebar">
      <div class="menu-sidebar-inner" id="categoriaNav">
      </div>
    </aside>

    <main class="menu-content" id="menuContent" data-categorie={categorieJson}>
      <div style="text-align:center; padding: 40px; color: var(--accent);">
        <span class="spinner" style="border-color: var(--accent) transparent var(--accent) transparent;"></span>
        <p>Caricamento menu in corso...</p>
      </div>
    </main>
  </div>
</Layout>

<style>
  .menu-hero { padding: 80px 24px 40px; text-align: center; border-bottom: 1px solid var(--border); }
  .menu-hero h1 { font-family: var(--font-display); font-size: clamp(2.5rem, 6vw, 4rem); margin-bottom: 12px; }
  .menu-layout { display: flex; gap: 48px; padding: 48px 24px 80px; align-items: flex-start; }
  .menu-sidebar { width: 240px; flex-shrink: 0; position: sticky; top: 100px; }
  .menu-sidebar-inner { display: flex; flex-direction: column; gap: 8px; }
  .cat-link { padding: 12px 16px; border-radius: var(--radius-sm); font-weight: 600; color: var(--text-soft); transition: all var(--transition); border: 1px solid transparent; cursor: pointer; display: block; text-decoration: none; }
  .cat-link:hover { background: rgba(200,146,42,0.08); color: var(--text); }
  .cat-link.active { background: rgba(200,146,42,0.15); border-color: rgba(200,146,42,0.3); color: var(--accent-light); }
  .menu-content { flex: 1; }
  .categoria-section { margin-bottom: 64px; scroll-margin-top: 100px; }
  .categoria-title { font-family: var(--font-display); font-size: 2rem; color: var(--accent-light); margin-bottom: 24px; padding-bottom: 12px; border-bottom: 1px dashed var(--border); }
  .prodotti-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; }
  .prodotto-card { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius-md); overflow: hidden; transition: transform var(--transition); display: flex; flex-direction: column; height: 100%; }
  .prodotto-card:hover { transform: translateY(-4px); border-color: rgba(200,146,42,0.4); }
  .prodotto-img-wrap { position: relative; height: 200px; overflow: hidden; }
  .prodotto-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
  .prodotto-card:hover .prodotto-img { transform: scale(1.05); }
  .prodotto-info { padding: 20px; display: flex; flex-direction: column; flex: 1; }
  .prodotto-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; gap: 12px; }
  .prodotto-nome { font-size: 1.1rem; font-weight: 700; margin: 0; }
  .prodotto-prezzo { font-family: var(--font-display); font-weight: 700; color: var(--accent-light); font-size: 1.1rem; }
  .prodotto-desc { font-size: 0.9rem; color: var(--text-soft); margin-bottom: 16px; line-height: 1.5; flex: 1; }
  .prodotto-meta { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 16px; }
  .badge { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; color: var(--muted); }
  .badge-alcol { background: rgba(231, 76, 60, 0.1); color: #e74c3c; border-color: rgba(231, 76, 60, 0.2); }
  .add-to-cart-btn { width: 100%; background: var(--bg); border: 1px solid var(--accent); color: var(--accent); padding: 10px; border-radius: var(--radius-sm); font-weight: 600; cursor: pointer; transition: all var(--transition); }
  .add-to-cart-btn:hover { background: var(--accent); color: #000; }
  @media (max-width: 768px) {
    .menu-layout { flex-direction: column; gap: 32px; padding-top: 24px; }
    .menu-sidebar { width: 100%; position: static; }
    .menu-sidebar-inner { flex-direction: row; overflow-x: auto; padding-bottom: 12px; white-space: nowrap; scrollbar-width: none; }
    .cat-link { flex: 0 0 auto; }
  }
</style>

<script>
  import { getFirebaseClient } from "../lib/firebase-client";
  import { collection, getDocs } from "firebase/firestore";

  async function caricaMenu() {
    const navEl = document.getElementById("categoriaNav");
    const contentEl = document.getElementById("menuContent");
    if (!contentEl || !navEl) return;

    // Legge le categorie passate da Astro senza spaccare TypeScript
    const categorieJson = contentEl.dataset.categorie || "[]";
    const categorie = JSON.parse(categorieJson);
    const { db } = getFirebaseClient();
    
    try {
      const snapshot = await getDocs(collection(db, "prodotti"));
      const prodotti = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() as any }));
      
      const prodottiAttivi = prodotti.filter(p => p.disponibile !== false);

      if (prodottiAttivi.length === 0) {
        contentEl.innerHTML = `<div style="text-align:center; padding:40px;">Il menu è in aggiornamento. Torna a breve!</div>`;
        return;
      }

      let htmlContent = "";
      let htmlNav = "";

      categorie.forEach((cat: any, index: number) => {
        const prodottiCat = prodottiAttivi.filter((p: any) => p.categoriaId === cat.id);
        if (prodottiCat.length === 0) return;

        htmlNav += `<a href="#cat-${cat.id}" class="cat-link ${index === 0 ? 'active' : ''}">${cat.emoji} ${cat.nome}</a>`;

        htmlContent += `
          <div class="categoria-section" id="cat-${cat.id}">
            <h2 class="categoria-title">${cat.emoji} ${cat.nome}</h2>
            <div class="prodotti-grid">
              ${prodottiCat.map((p: any) => `
                <div class="prodotto-card">
                  <div class="prodotto-img-wrap">
                    <img class="prodotto-img" src="${p.immagine || '/images/placeholder.svg'}" alt="${p.nome}" loading="lazy" />
                  </div>
                  <div class="prodotto-info">
                    <div class="prodotto-header">
                      <h3 class="prodotto-nome">${p.nome}</h3>
                      <span class="prodotto-prezzo">€ ${Number(p.prezzo).toFixed(2).replace('.', ',')}</span>
                    </div>
                    <p class="prodotto-desc">${p.descrizione || ''}</p>
                    <div class="prodotto-meta">
                      ${p.alcolico ? `<span class="badge badge-alcol">Alcolico ${p.gradazione ? p.gradazione : ''}</span>` : ''}
                      ${p.allergeni && p.allergeni.length ? `<span class="badge" title="Allergeni">⚠️ ${p.allergeni.join(', ')}</span>` : ''}
                    </div>
                    <button class="add-to-cart-btn" onclick='aggiungiAlCarrello(${JSON.stringify(p).replace(/'/g, "&#39;")})'>
                      Aggiungi al carrello
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });

      navEl.innerHTML = htmlNav;
      contentEl.innerHTML = htmlContent;

    } catch (err) {
      console.error(err);
      contentEl.innerHTML = `<div style="text-align:center; padding:40px; color:red;">Errore caricamento menu. Aggiorna la pagina.</div>`;
    }
  }

  const CART_KEY = "puborder_cart";
  (window as any).aggiungiAlCarrello = function(prodotto: any) {
    try {
      let cart = JSON.parse(localStorage.getItem(CART_KEY) || "[]");
      const idx = cart.findIndex((i: any) => i.id === prodotto.id);
      if (idx >= 0) {
        cart[idx].quantita += 1;
      } else {
        cart.push({
          id: prodotto.id,
          nome: prodotto.nome,
          prezzo: Number(prodotto.prezzo),
          immagine: prodotto.immagine || '/images/placeholder.svg',
          quantita: 1
        });
      }
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
      alert(`✅ ${prodotto.nome} aggiunto al carrello!`);
    } catch(e) {
      console.error(e);
    }
  };

  caricaMenu();
</script>