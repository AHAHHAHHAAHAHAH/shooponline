---
import AdminLayout from "../../layouts/AdminLayout.astro";
---

<AdminLayout title="Gestione Ordini" activeNav="ordini">
  <div class="admin-header">
    <h1>Ordini in arrivo</h1>
    <div class="status-badge">üü¢ In ascolto...</div>
  </div>

  <div class="ordini-grid" id="ordiniContainer">
    <div style="text-align:center; padding: 40px; grid-column: 1/-1;">
      Caricamento ordini in corso...
    </div>
  </div>

  <audio id="notificationSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
</AdminLayout>

<style>
  .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .status-badge { background: #2ecc71; color: #111; padding: 4px 12px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; animation: pulse 2s infinite; }
  .ordini-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
  :global(.ordine-card) { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
  :global(.ordine-header) { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
  :global(.tavolo-badge) { background: var(--accent); color: #000; padding: 4px 10px; border-radius: 4px; font-weight: 900; font-size: 1.2rem; }
  :global(.stato-badge) { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
  :global(.stato-in_attesa) { background: #f39c12; color: #fff; }
  :global(.stato-ricevuto) { background: #2ecc71; color: #fff; }
  :global(.items-list) { list-style: none; padding: 0; margin: 0; font-size: 0.95rem; }
  :global(.items-list li) { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dashed rgba(255,255,255,0.1); }
  :global(.ordine-footer) { display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 12px; font-weight: bold; }
  @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
</style>

<script>
  import { getFirebaseClient } from "../../lib/firebase-client";
  import { collection, query, orderBy, limit, onSnapshot, updateDoc, doc } from "firebase/firestore";
  import { onAuthStateChanged } from "firebase/auth";

  const { auth, db } = getFirebaseClient();
  const container = document.getElementById("ordiniContainer")!;
  const sound = document.getElementById("notificationSound") as HTMLAudioElement;
  
  onAuthStateChanged(auth, (user) => { 
    if (!user) {
      window.location.href = "/admin"; 
    } else {
      iniziaAscoltoOrdini();
    }
  });

  function iniziaAscoltoOrdini() {
    let isFirstLoad = true;
    const q = query(collection(db, "ordini"), orderBy("creatoAt", "desc"), limit(50));
    
    onSnapshot(q, (snapshot) => {
      if (!isFirstLoad) {
        snapshot.docChanges().forEach((change) => {
          if (change.type === "added") sound.play().catch(e => console.log(e));
        });
      }
      isFirstLoad = false;
      container.innerHTML = ""; 
      
      if (snapshot.empty) {
        container.innerHTML = `<div style="text-align:center; padding: 40px; grid-column: 1/-1; color: var(--muted);">Nessun ordine presente.</div>`;
        return;
      }

      snapshot.docs.forEach((documento) => {
        const ordine = documento.data();
        const id = documento.id;
        const card = document.createElement("div");
        card.className = "ordine-card";
        
        const dataFormat = ordine.creatoAt?.toDate ? ordine.creatoAt.toDate().toLocaleTimeString() : "Ora sconosciuta";
        const itemsHtml = ordine.items.map((i: any) => `
          <li><span>${i.quantita}x ${i.nomeProdotto}</span><span>‚Ç¨${i.totaleRiga.toFixed(2)}</span></li>
        `).join("");
        
        card.innerHTML = `
          <div class="ordine-header">
            <span class="tavolo-badge">Tavolo ${ordine.numeroTavolo}</span>
            <span class="stato-badge stato-${ordine.stato}">${ordine.stato === 'in_attesa' ? '‚è≥ In Attesa' : '‚úÖ Ricevuto'}</span>
          </div>
          <div>
            <small style="color: gray;">Ordine: ${id.slice(-6)} ‚Ä¢ Ore: ${dataFormat}</small><br/>
            <small>Metodo: <strong>${(ordine.metodoPagamento || 'cassa').toUpperCase()}</strong> - Pagato: ${ordine.pagato ? 'S√¨' : 'No'}</small>
          </div>
          <ul class="items-list">${itemsHtml}</ul>
          ${ordine.noteOrdine ? `<div style="background: rgba(231, 76, 60, 0.2); padding: 8px; border-radius: 4px; font-size:0.85rem;"><strong>Note:</strong> ${ordine.noteOrdine}</div>` : ''}
          <div class="ordine-footer"><span>Totale:</span><span>‚Ç¨${Number(ordine.totale).toFixed(2)}</span></div>
          <div style="display: flex; gap: 8px; margin-top: 12px;">
            ${ordine.stato === 'in_attesa' ? 
              `<button class="btn btn-primary btn-sm accetta-btn" data-id="${id}" style="flex:1;">Accetta</button>` : 
              `<button class="btn btn-ghost btn-sm completa-btn" data-id="${id}" style="flex:1;">Completato</button>`
            }
          </div>
        `;
        container.appendChild(card);
      });

      document.querySelectorAll('.accetta-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => await updateDoc(doc(db, "ordini", (e.target as any).dataset.id), { stato: "ricevuto" }));
      });
      document.querySelectorAll('.completa-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => await updateDoc(doc(db, "ordini", (e.target as any).dataset.id), { stato: "completato" }));
      });
    });
  }
</script>