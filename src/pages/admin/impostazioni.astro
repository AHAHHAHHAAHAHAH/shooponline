---
import AdminLayout from "../../layouts/AdminLayout.astro";
import data from "../../data/data.json";

const pub = data.pub;
---

<AdminLayout title="Impostazioni" activeNav="impostazioni">
  <div class="page-header">
    <h1>Impostazioni</h1>
    <p>Modifica i dati del pub visibili sul sito</p>
  </div>

  <div class="card" style="padding:32px; max-width:700px;">
    <form id="impostazioniForm">

      <div class="form-section">
        <h3>Dati generali</h3>
        <div class="form-grid">
          <div class="form-group">
            <label class="label">Nome pub</label>
            <input type="text" id="iNome" class="input" value={pub.nome} />
          </div>
          <div class="form-group">
            <label class="label">Tagline</label>
            <input type="text" id="iTagline" class="input" value={pub.tagline} />
          </div>
          <div class="form-group" style="grid-column:1/-1;">
            <label class="label">Descrizione</label>
            <textarea id="iDescrizione" class="input" rows="3">{pub.descrizione}</textarea>
          </div>
          <div class="form-group">
            <label class="label">Indirizzo</label>
            <input type="text" id="iIndirizzo" class="input" value={pub.indirizzo} />
          </div>
          <div class="form-group">
            <label class="label">Telefono</label>
            <input type="tel" id="iTelefono" class="input" value={pub.telefono} />
          </div>
          <div class="form-group">
            <label class="label">Email</label>
            <input type="email" id="iEmail" class="input" value={pub.email} />
          </div>
          <div class="form-group">
            <label class="label">WhatsApp (E.164)</label>
            <input type="text" id="iWhatsapp" class="input" value={pub.whatsapp} placeholder="+393331234567" />
          </div>
          <div class="form-group">
            <label class="label">Tempo attesa medio</label>
            <input type="text" id="iTempoAttesa" class="input" value={pub.tempoAttesaMedio} placeholder="15-20 minuti" />
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="form-section">
        <h3>Ordini & pagamenti</h3>
        <div class="form-group checkbox-row">
          <label class="checkbox-label">
            <input type="checkbox" id="iOrdiniAbilitati" checked={pub.ordiniAbilitati} />
            Ordini dal tavolo abilitati
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="iStripeEnabled" checked={pub.stripeEnabled} />
            Pagamenti con carta (Stripe)
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="iCashEnabled" checked={pub.cashEnabled} />
            Pagamento in cassa
          </label>
        </div>
        <div class="form-group" style="margin-top:16px;">
          <label class="label">Messaggio chiusura</label>
          <input type="text" id="iMsgChiusura" class="input" value={pub.messaggioChiusura} />
        </div>
      </div>

      <div class="divider"></div>

      <div class="form-section">
        <h3>Social</h3>
        <div class="form-grid">
          <div class="form-group">
            <label class="label">Instagram (solo handle)</label>
            <input type="text" id="iInstagram" class="input" value={pub.social.instagram} placeholder="thedarkhorsepub" />
          </div>
          <div class="form-group">
            <label class="label">Facebook</label>
            <input type="text" id="iFacebook" class="input" value={pub.social.facebook} />
          </div>
        </div>
      </div>

      <div id="saveMsg" style="display:none;" class="save-msg"></div>

      <div style="margin-top:24px;">
        <button type="submit" class="btn btn-primary btn-lg">Salva impostazioni</button>
      </div>
    </form>
  </div>
</AdminLayout>

<style>
  .form-section { margin-bottom: 24px; }
  .form-section h3 { font-size: 1.1rem; margin-bottom: 20px; color: var(--accent-light); }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .form-group { display: flex; flex-direction: column; gap: 8px; }
  .checkbox-row { display: flex; flex-direction: column; gap: 12px; }
  .checkbox-label { display: flex; align-items: center; gap: 10px; cursor: pointer; }
  .save-msg { padding: 12px 16px; border-radius: var(--radius-sm); font-weight: 600; margin-bottom: 8px; }
  .save-ok { background: var(--success-bg); color: var(--success); border: 1px solid var(--success); }
  .save-err { background: var(--danger-bg); color: var(--danger); }
  @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }
</style>

<script>
  import { getFirebaseClient } from "../../lib/firebase-client";
  import { onAuthStateChanged } from "firebase/auth";
  const { auth } = getFirebaseClient();
  onAuthStateChanged(auth, (user) => { if (!user) window.location.href = "/admin"; });

  document.getElementById("impostazioniForm")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const saveMsg = document.getElementById("saveMsg")!;

    const updates = {
      nome: (document.getElementById("iNome") as HTMLInputElement).value,
      tagline: (document.getElementById("iTagline") as HTMLInputElement).value,
      descrizione: (document.getElementById("iDescrizione") as HTMLTextAreaElement).value,
      indirizzo: (document.getElementById("iIndirizzo") as HTMLInputElement).value,
      telefono: (document.getElementById("iTelefono") as HTMLInputElement).value,
      email: (document.getElementById("iEmail") as HTMLInputElement).value,
      whatsapp: (document.getElementById("iWhatsapp") as HTMLInputElement).value,
      tempoAttesaMedio: (document.getElementById("iTempoAttesa") as HTMLInputElement).value,
      ordiniAbilitati: (document.getElementById("iOrdiniAbilitati") as HTMLInputElement).checked,
      stripeEnabled: (document.getElementById("iStripeEnabled") as HTMLInputElement).checked,
      cashEnabled: (document.getElementById("iCashEnabled") as HTMLInputElement).checked,
      messaggioChiusura: (document.getElementById("iMsgChiusura") as HTMLInputElement).value,
      social: {
        instagram: (document.getElementById("iInstagram") as HTMLInputElement).value,
        facebook: (document.getElementById("iFacebook") as HTMLInputElement).value,
      },
    };

    const res = await fetch("/api/admin/salva-impostazioni", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(updates),
    });

    saveMsg.style.display = "block";
    if (res.ok) {
      saveMsg.className = "save-msg save-ok";
      saveMsg.textContent = "âœ“ Impostazioni salvate con successo!";
    } else {
      saveMsg.className = "save-msg save-err";
      saveMsg.textContent = "Errore durante il salvataggio. Riprova.";
    }
    setTimeout(() => saveMsg.style.display = "none", 3000);
  });
</script>
