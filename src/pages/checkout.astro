---
import Layout from "../layouts/Layout.astro";
import data from "../data/data.json";

const pub = data.pub;
const stripePk = import.meta.env.PUBLIC_STRIPE_PUBLISHABLE_KEY || "";
---

<Layout title="Il tuo Ordine ‚Äî Cassa">
  <div id="checkoutData" data-stripe-pk={stripePk} data-coperto={pub.coperto} style="display:none;"></div>

  <div class="container checkout-container">
    
    <div class="checkout-main">
      <div class="card glass p-6">
        <div class="section-header-small">
          <span class="kicker">Riepilogo</span>
          <h2 class="title-display" style="font-size: 2rem;">Il tuo Ordine</h2>
        </div>

        <ul id="cartItems" class="cart-list">
          </ul>

        <div class="cart-totals">
          <div class="total-row">
            <span>Coperto</span>
            <span>‚Ç¨ {pub.coperto.toFixed(2).replace('.', ',')}</span>
          </div>
          <div class="total-row grand-total">
            <span>Totale da pagare</span>
            <span id="cartTotal">‚Ç¨ 0,00</span>
          </div>
        </div>

        <div class="form-group" style="margin-top: 24px;">
          <label class="label">Note per la cucina (Opzionale)</label>
          <textarea id="noteCucina" class="input" rows="2" placeholder="Es. Senza ghiaccio, carne ben cotta..."></textarea>
        </div>
      </div>
    </div>

    <div class="checkout-sidebar">
      <div class="card glass p-6 sticky-sidebar">
        <h3 class="title-display" style="font-size: 1.6rem; margin-bottom: 24px;">Completa l'ordine</h3>
        
        <div class="form-group table-input-group">
          <label class="label" style="color: var(--accent-light); font-size: 1rem;">üìç Numero del tuo tavolo *</label>
          <input type="number" id="inputTavolo" class="input table-input" placeholder="Es. 12" required min="1" />
        </div>

        <div id="paymentSection" class="payment-actions">
          <button id="btnStripe" class="btn btn-primary w-full">
            üí≥ Paga con Carta / Apple Pay
          </button>
          <button id="btnCassa" class="btn btn-ghost w-full" style="margin-top: 12px;">
            üíµ Paga in Cassa alla fine
          </button>
        </div>

        <div id="stripeWrapper" class="stripe-box">
          <div class="stripe-header">Inserisci i dati della carta</div>
          <div id="payment-element" class="payment-element-container"></div>
          <button id="submitStripe" class="btn btn-primary w-full" style="margin-top: 20px;">
            Conferma e Paga
          </button>
          <div id="payment-message" class="error-msg"></div>
          <button id="cancelStripe" class="btn btn-ghost btn-sm w-full" style="margin-top: 12px; border:none;">
            Annulla
          </button>
        </div>

        <div id="emptyCartMsg" class="empty-cart-msg">
          <p>Il tuo carrello √® vuoto.</p>
          <a href="/menu" class="btn btn-primary btn-sm">Torna al menu</a>
        </div>
      </div>
    </div>

  </div>
</Layout>

<style>
  .checkout-container {
    display: grid;
    grid-template-columns: 1.5fr 1fr;
    gap: 40px;
    padding-top: 80px;
    padding-bottom: 80px;
    align-items: flex-start;
  }
  .p-6 { padding: 32px; }
  .w-full { width: 100%; justify-content: center; }
  .section-header-small { margin-bottom: 32px; border-bottom: 1px solid var(--border-light); padding-bottom: 16px; }
  
  .cart-list { list-style: none; margin-bottom: 24px; }
  .cart-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 0; border-bottom: 1px dashed var(--border-subtle);
  }
  .cart-item-info { display: flex; align-items: center; gap: 16px; }
  .cart-item-img { width: 56px; height: 56px; border-radius: 8px; object-fit: cover; }
  .cart-item-title { font-family: var(--font-serif); font-size: 1.2rem; font-weight: 600; color: #fff; }
  .cart-item-price { color: var(--text-muted); font-size: 0.9rem; }
  .cart-item-qty {
    display: flex; align-items: center; gap: 12px;
    background: rgba(255,255,255,0.03); border: 1px solid var(--border-light);
    border-radius: 99px; padding: 4px 8px;
  }
  .qty-btn { background: none; border: none; color: var(--accent-primary); font-size: 1.2rem; cursor: pointer; padding: 0 8px; }
  .qty-btn:hover { color: #fff; }
  .qty-num { font-weight: 700; font-size: 1rem; min-width: 20px; text-align: center; }

  .cart-totals { background: rgba(0,0,0,0.3); padding: 24px; border-radius: 12px; border: 1px solid var(--border-subtle); }
  .total-row { display: flex; justify-content: space-between; color: var(--text-muted); margin-bottom: 12px; font-size: 1rem; }
  .grand-total { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-light); color: var(--accent-light); font-size: 1.6rem; font-weight: 700; margin-bottom: 0; }

  .sticky-sidebar { position: sticky; top: 120px; }
  .table-input-group { background: rgba(212, 175, 55, 0.05); border: 1px solid var(--border-gold); padding: 20px; border-radius: 12px; margin-bottom: 32px; }
  .table-input { font-size: 1.5rem; text-align: center; font-weight: 700; letter-spacing: 2px; }
  .table-input::placeholder { font-size: 1.2rem; font-weight: 400; letter-spacing: normal; }

  .stripe-box { display: none; margin-top: 24px; background: #fff; padding: 24px; border-radius: 12px; }
  .stripe-header { color: #000; font-weight: 700; margin-bottom: 16px; font-size: 1.1rem; text-align: center; }
  .payment-element-container { min-height: 200px; }
  .error-msg { color: var(--status-danger); margin-top: 12px; font-size: 0.9rem; text-align: center; display: none; }
  
  .empty-cart-msg { text-align: center; padding: 40px 0; display: none; }
  .empty-cart-msg p { color: var(--text-muted); margin-bottom: 16px; font-size: 1.1rem; }

  @media (max-width: 900px) {
    .checkout-container { grid-template-columns: 1fr; gap: 32px; padding-top: 40px; }
    .sticky-sidebar { position: static; }
  }
</style>

<script is:inline src="https://js.stripe.com/v3/"></script>
<script is:inline>
  const dataEl = document.getElementById("checkoutData");
  const stripePk = dataEl ? dataEl.dataset.stripePk : "";
  const coperto = parseFloat(dataEl && dataEl.dataset.coperto ? dataEl.dataset.coperto : "0");
  
  const CART_KEY = "puborder_cart";
  let cart = JSON.parse(localStorage.getItem(CART_KEY) || "[]");

  const cartItemsEl = document.getElementById("cartItems");
  const totalEl = document.getElementById("cartTotal");
  const paymentSection = document.getElementById("paymentSection");
  const emptyMsg = document.getElementById("emptyCartMsg");
  const inputTavolo = document.getElementById("inputTavolo");
  const btnCassa = document.getElementById("btnCassa");
  const btnStripe = document.getElementById("btnStripe");

  function renderCart() {
    if(!cartItemsEl || !paymentSection || !emptyMsg || !totalEl) return;
    
    cartItemsEl.innerHTML = "";
    if (cart.length === 0) {
      paymentSection.style.display = "none";
      emptyMsg.style.display = "block";
      totalEl.textContent = "‚Ç¨ 0,00";
      return;
    }

    let subtotal = 0;
    cart.forEach((item, idx) => {
      subtotal += item.prezzo * item.quantita;
      cartItemsEl.innerHTML += `
        <li class="cart-item">
          <div class="cart-item-info">
            <img src="${item.immagine}" class="cart-item-img" onerror="this.src='/images/placeholder.svg'" />
            <div>
              <div class="cart-item-title">${item.nome}</div>
              <div class="cart-item-price">‚Ç¨ ${Number(item.prezzo).toFixed(2).replace('.', ',')}</div>
            </div>
          </div>
          <div class="cart-item-qty">
            <button class="qty-btn" onclick="changeQty(${idx}, -1)">-</button>
            <span class="qty-num">${item.quantita}</span>
            <button class="qty-btn" onclick="changeQty(${idx}, 1)">+</button>
          </div>
        </li>
      `;
    });
    
    const totale = subtotal + coperto;
    totalEl.textContent = `‚Ç¨ ${totale.toFixed(2).replace('.', ',')}`;
    paymentSection.style.display = "block";
    emptyMsg.style.display = "none";
  }

  window.changeQty = (idx, delta) => {
    cart[idx].quantita += delta;
    if (cart[idx].quantita <= 0) cart.splice(idx, 1);
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
    renderCart();
  };

  renderCart();

  // PAGAMENTO CASSA
  if(btnCassa) {
    btnCassa.addEventListener("click", async (e) => {
      e.preventDefault();
      if (!inputTavolo || !inputTavolo.value) { 
        alert("‚ö†Ô∏è Inserisci il numero del tuo tavolo per continuare!"); 
        if(inputTavolo) inputTavolo.focus(); 
        return; 
      }

      const btn = e.currentTarget;
      const originalText = btn.innerHTML;
      btn.disabled = true; 
      btn.innerHTML = `<span class="spinner" style="width:16px;height:16px;border-width:2px;margin-right:8px;"></span> Invio ordine...`;

      try {
        const noteCucinaEl = document.getElementById("noteCucina");
        const noteOrdine = noteCucinaEl ? noteCucinaEl.value : "";
        
        const res = await fetch("/api/crea-ordine", {
          method: "POST", 
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            numeroTavolo: inputTavolo.value,
            items: cart.map(i => ({ prodottoId: i.id, quantita: i.quantita })),
            noteOrdine: noteOrdine
          })
        });
        
        if (res.ok) {
          localStorage.removeItem(CART_KEY);
          window.location.replace("/pagamento/successo"); 
        } else {
          const errorData = await res.json().catch(()=>({}));
          alert(`‚ùå Errore del server: ${errorData.error || "Impossibile inviare l'ordine."}`);
          btn.disabled = false; btn.innerHTML = originalText;
        }
      } catch (err) { 
        alert("‚ùå Nessuna connessione a internet o server irraggiungibile."); 
        btn.disabled = false; btn.innerHTML = originalText;
      }
    });
  }

  // PAGAMENTO STRIPE
  let stripeElements;
  let stripeInstance; 
  
  const stripeWrapper = document.getElementById("stripeWrapper");
  const cancelStripe = document.getElementById("cancelStripe");
  const submitStripe = document.getElementById("submitStripe");
  
  if(btnStripe) {
    btnStripe.addEventListener("click", async (e) => {
      e.preventDefault();
      
      if (!stripePk) return alert("‚ö†Ô∏è Pagamenti con carta disabilitati (Manca API Key).");
      if (!inputTavolo || !inputTavolo.value) { 
        alert("‚ö†Ô∏è Inserisci il numero del tavolo prima di pagare!"); 
        if(inputTavolo) inputTavolo.focus(); 
        return; 
      }

      const btn = e.currentTarget;
      const originalText = btn.innerHTML;
      btn.disabled = true; 
      btn.innerHTML = `<span class="spinner" style="width:16px;height:16px;border-width:2px;margin-right:8px;border-top-color:#000;"></span> Connessione Sicura...`;

      try {
        stripeInstance = window.Stripe(stripePk);
        const noteCucinaEl = document.getElementById("noteCucina");
        const noteOrdine = noteCucinaEl ? noteCucinaEl.value : "";

        const res = await fetch("/api/create-payment-intent", {
          method: "POST", 
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            ordineData: { 
              numeroTavolo: inputTavolo.value, 
              items: cart.map(i => ({prodottoId: i.id, quantita: i.quantita})), 
              noteOrdine: noteOrdine 
            } 
          })
        });
        
        if (!res.ok) throw new Error("Errore durante la creazione del pagamento");
        const { clientSecret } = await res.json();
        
        stripeElements = stripeInstance.elements({ clientSecret, appearance: { theme: 'stripe' } });
        const paymentElement = stripeElements.create('payment');
        paymentElement.mount('#payment-element');
        
        if(paymentSection) paymentSection.style.display = "none";
        if(stripeWrapper) stripeWrapper.style.display = "block";
      } catch (err) { 
        alert("‚ùå Errore di connessione al sistema bancario."); 
        btn.disabled = false; btn.innerHTML = originalText; 
      }
    });
  }

  if(cancelStripe) {
    cancelStripe.addEventListener("click", (e) => {
      e.preventDefault();
      if(stripeWrapper) stripeWrapper.style.display = "none";
      if(paymentSection) paymentSection.style.display = "block";
      if(btnStripe) {
        btnStripe.disabled = false;
        btnStripe.innerHTML = "üí≥ Paga con Carta / Apple Pay";
      }
    });
  }

  if(submitStripe) {
    submitStripe.addEventListener("click", async (e) => {
      e.preventDefault();
      const btn = e.currentTarget;
      btn.disabled = true; 
      btn.textContent = "Elaborazione in corso...";
      
      const { error } = await stripeInstance.confirmPayment({
        elements: stripeElements, 
        confirmParams: { return_url: window.location.origin + "/pagamento/successo" }
      });
      
      if (error) {
        const msg = document.getElementById("payment-message");
        if(msg) {
          msg.textContent = error.message;
          msg.style.display = "block";
        }
        btn.disabled = false; 
        btn.textContent = "Riprova Pagamento";
      }
    });
  }
</script>