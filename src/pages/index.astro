---
import Layout from "../layouts/Layout.astro";
import data from "../data/data.json";

const pub = data.pub;
// TUTTO √à GESTITO DA FIREBASE IN TEMPO REALE
---

<Layout>
  <section class="hero">
    <div class="hero-bg"><div class="hero-overlay"></div></div>
    <nav class="nav container">
      <a href="/" class="nav-logo"><span class="logo-text">{pub.nome}</span></a>
      <div class="nav-actions">
        <a href="/menu" class="btn btn-ghost btn-sm">Menu</a>
        <a href="/tavolo/1" class="btn btn-primary btn-sm">Ordina ora</a>
      </div>
    </nav>
    <div class="hero-content container">
      <div class="hero-badge"><span class="badge badge-accent">Ordina dal tavolo via QR</span></div>
      <h1 class="hero-title">{pub.nome}</h1>
      <p class="hero-tagline">{pub.tagline}</p>
      <p class="hero-desc">{pub.descrizione}</p>
      <div class="hero-actions">
        <a href="/menu" class="btn btn-primary btn-lg">Sfoglia il menu</a>
      </div>
    </div>
  </section>

  <section class="section" id="evidenza">
    <div class="container">
      <div class="section-header">
        <span class="kicker">Le nostre proposte</span>
        <h2>I preferiti del pub</h2>
      </div>
      
      <div class="prodotti-grid" id="evidenzaContainer">
        <div style="text-align:center; padding: 40px; grid-column: 1/-1; color: var(--muted);">
          <span class="spinner" style="border-color: var(--accent) transparent var(--accent) transparent;"></span>
        </div>
      </div>
    </div>
  </section>

  <section class="section section-dark">
    <div class="container">
      <div class="section-header">
        <span class="kicker">Il nostro menu</span>
        <h2>Ogni voglia, una categoria</h2>
      </div>
      <div class="categorie-grid" id="categorieHomeContainer">
         <div style="text-align:center; padding: 20px; color: var(--muted); grid-column: 1/-1;">Caricamento categorie...</div>
      </div>
    </div>
  </section>

  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div><div class="footer-logo">{pub.nome}</div></div>
      </div>
    </div>
  </footer>
</Layout>

<style>
  /* MANTENI ESATTAMENTE TUTTO IL TUO CSS ATTUALE DI INDEX.ASTRO. NON TOCCARLO. */
  .hero { position: relative; min-height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
  .hero-bg { position: absolute; inset: 0; background: radial-gradient(ellipse at 30% 50%, rgba(200,146,42,0.08) 0%, transparent 60%), radial-gradient(ellipse at 70% 30%, rgba(200,146,42,0.05) 0%, transparent 50%); }
  .hero-overlay { position: absolute; inset: 0; background: linear-gradient(to bottom, transparent 60%, var(--bg) 100%); }
  .nav { position: relative; z-index: 10; display: flex; align-items: center; justify-content: space-between; padding-top: 24px; padding-bottom: 24px; }
  .nav-logo { display: flex; align-items: center; gap: 12px; }
  .logo-text { font-family: var(--font-display); font-size: 1.4rem; font-weight: 700; color: var(--accent-light); }
  .nav-actions { display: flex; gap: 12px; }
  .hero-content { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 80px 24px; position: relative; z-index: 5; }
  .hero-badge { margin-bottom: 24px; }
  .hero-title { font-size: clamp(3rem, 8vw, 7rem); font-weight: 900; color: var(--text); line-height: 1; margin-bottom: 16px; background: linear-gradient(135deg, var(--text) 0%, var(--accent-light) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
  .hero-tagline { font-family: var(--font-display); font-size: clamp(1.1rem, 2.5vw, 1.6rem); color: var(--accent); font-style: italic; margin-bottom: 20px; }
  .hero-desc { max-width: 60ch; font-size: 1.05rem; line-height: 1.7; margin-bottom: 40px; color: var(--text-soft); }
  .section-header { text-align: center; margin-bottom: 48px; }
  .section-header h2 { margin-bottom: 12px; }
  .section-dark { background: var(--panel); }
  .prodotti-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; }
  .prodotto-card { overflow: hidden; display: flex; flex-direction: column; transition: transform var(--transition); }
  .prodotto-card:hover { transform: translateY(-4px); }
  .prodotto-img-wrap { position: relative; aspect-ratio: 16/10; overflow: hidden; }
  .prodotto-img-wrap img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
  .prodotto-card:hover .prodotto-img-wrap img { transform: scale(1.05); }
  .alcolico-badge { position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.75); backdrop-filter: blur(4px); padding: 4px 10px; border-radius: 99px; font-size: 0.75rem; font-weight: 600; color: var(--accent-light); }
  .prodotto-body { padding: 20px; flex: 1; display: flex; flex-direction: column; }
  .prodotto-cat { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 8px; font-weight: 600; }
  .prodotto-nome { font-family: var(--font-display); font-size: 1.3rem; margin-bottom: 8px; color: var(--text); }
  .prodotto-desc { font-size: 0.9rem; color: var(--muted); line-height: 1.5; flex: 1; margin-bottom: 16px; }
  .prodotto-footer { display: flex; align-items: center; justify-content: space-between; }
  .prodotto-cta { font-size: 0.85rem; color: var(--accent); font-weight: 600; }
  .categorie-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
  .cat-card { padding: 28px 20px; text-align: center; transition: all var(--transition); cursor: pointer; }
  .cat-card:hover { background: rgba(200,146,42,0.08); border-color: var(--accent); transform: translateY(-2px); }
  .cat-emoji { font-size: 2.5rem; display: block; margin-bottom: 12px; }
  .cat-nome { font-family: var(--font-display); font-size: 1.1rem; margin-bottom: 8px; }
  .footer { background: var(--panel); border-top: 1px solid var(--border); padding: 48px 0 32px; }
  .footer-content { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 32px; }
  .footer-logo { font-family: var(--font-display); font-size: 1.4rem; color: var(--accent-light); font-weight: 700; }
</style>

<script>
  import { getFirebaseClient } from "../lib/firebase-client";
  import { collection, onSnapshot, query, orderBy } from "firebase/firestore";

  const evContainer = document.getElementById("evidenzaContainer");
  const catContainer = document.getElementById("categorieHomeContainer");

  if (evContainer || catContainer) {
    const { db } = getFirebaseClient();
    let categorie: any[] = [];
    let prodotti: any[] = [];
    let catLoaded = false;
    let prodLoaded = false;

    onSnapshot(query(collection(db, "categorie"), orderBy("ordinamento", "asc")), (snap) => {
      categorie = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      catLoaded = true;

      // Disegna le categorie nella Home in tempo reale
      if (catContainer) {
        catContainer.innerHTML = categorie.map((cat: any) => `
          <a href="/menu#cat-${cat.id}" class="cat-card card">
            <span class="cat-emoji">${cat.emoji || ''}</span>
            <h3 class="cat-nome">${cat.nome}</h3>
          </a>
        `).join("");
      }

      if (prodLoaded) renderEvidenza();
    });

    onSnapshot(collection(db, "prodotti"), (snap) => {
      prodotti = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      prodLoaded = true;
      if (catLoaded) renderEvidenza();
    });

    function renderEvidenza() {
      if (!evContainer) return;
      const catMap = Object.fromEntries(categorie.map((c: any) => [c.id, c]));
      const evidenza = prodotti.filter((p: any) => p.inEvidenza && p.disponibile !== false).slice(0, 6);

      if (evidenza.length === 0) {
        evContainer.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--muted);">Nessun prodotto in evidenza.</div>`;
        return;
      }

      evContainer.innerHTML = evidenza.map((p: any) => {
        const cat = catMap[p.categoriaId] || { emoji: 'üçΩÔ∏è', nome: 'Varie' };
        return `
          <a href="/menu#cat-${p.categoriaId}" class="prodotto-card card card-glow">
            <div class="prodotto-img-wrap">
              <img src="${p.immagine || '/images/placeholder.svg'}" alt="${p.nome}" loading="lazy" onerror="this.src='/images/placeholder.svg'" />
              ${p.alcolico ? `<span class="alcolico-badge">üç∏ ${p.gradazione || ''}</span>` : ''}
            </div>
            <div class="prodotto-body">
              <div class="prodotto-cat">${cat.emoji || ''} ${cat.nome}</div>
              <h3 class="prodotto-nome">${p.nome}</h3>
              <p class="prodotto-desc">${p.descrizione || ''}</p>
              <div class="prodotto-footer">
                <span class="price">‚Ç¨ ${Number(p.prezzo).toFixed(2).replace('.', ',')}</span>
                <span class="prodotto-cta">Ordina ‚Üí</span>
              </div>
            </div>
          </a>
        `;
      }).join("");
    }
  }
</script>